library(lhs)
library(geostats)
library(deSolve)
library(cmdstanr)
library(rstan)
library(truncnorm)
library(shinystan)
sir <- function(t, y, params) {
with(as.list(c(params, y)), {
S = y[1]
I = y[2]
dS = -beta*S*I/N
dI = beta*S*I/N-gamma*I
list(c(dS,dI))
})
}
ds = function(s,i,beta,gamma){
-beta*s*i/N
}
di = function(s,i,beta,gamma){
beta*s*i/N-gamma*i
}
sim <- function(beta,gamma, time, h){
s = i = c()
s[1] = N-1
i[1] = 1
for(t in 2:(time/h)){
s[t] <- s[t-1] + h * ds(s[t-1],i[t-1],beta,gamma)
i[t] <- i[t-1] + h * di(s[t-1],i[t-1],beta,gamma)
}
return(i)
}
nobs = 70;nsims=10
N=1e6
x = 1:nobs
simulation<- function(beta,gamma,x){
out = ode(c(N-10,10), x, sir, list(beta=beta,gamma=gamma, method="ode45"))[,3]
(out)
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
sim_test=array(c(runif(1,.5,1),runif(1,0,.5)))
ytest=log((simulation(sim_test[1],sim_test[2],x))+1)
ytest=ytest-mean(cbind(ysims,ytest))
oldmean = rowMeans(ysims)
ysims=ysims-mean(ysims)
matplot((ysims),type="l")
points(ytest,pch=8)
model_data = list('T'=nrow(ysims),num_series=ncol(ysims),
y=ysims,p=2,
theta=matrix(sim_pars,ncol=2),num_pred=nrow(matrix(sim_test,nrow=1)),
theta_pred=matrix(sim_test,nrow=1),lags=1,inits=as.array(ytest[1]))
file <- file.path("dlm_emulator_kalman.stan")
model <- cmdstan_model(file)
mcmc <- model$sample(data = model_data,
max_treedepth = 10,adapt_delta = .8,
chains = 2,
iter_warmup = 250,
iter_sampling =250,
refresh = 2, parallel_chains = getOption("mc.cores", 4))
stanfit <- rstan::read_stan_csv(mcmc$output_files())
ypred = mcmc$draws("ypred")
yz1=yz2=yz3=yz3=yz4=yz5=yz6=yz7=yz8=yz9=ypredmean=u=l=out= c()
for(i in 1:(nobs)){
ypredmean[i] = median((c(ypred[,,i])))
l[i] = quantile(c(ypred[,,i]),0.025)
u[i] = quantile(c(ypred[,,i]),0.975)
}
plot(exp(ytest),ylim=c(min(exp(ytest),exp(ypredmean),exp(l)),max(exp(ytest),exp(ypredmean),exp(u))),col="blue",pch=19)
points(exp(ypredmean),col="red",lwd=3)
lines(exp(u),col="black",lwd=3,lty=3)
lines(exp(l),col="black",lwd=3,lty=3)
library(lhs)
library(geostats)
library(deSolve)
library(cmdstanr)
library(rstan)
library(truncnorm)
library(shinystan)
sir <- function(t, y, params) {
with(as.list(c(params, y)), {
S = y[1]
I = y[2]
dS = -beta*S*I/N
dI = beta*S*I/N-gamma*I
list(c(dS,dI))
})
}
ds = function(s,i,beta,gamma){
-beta*s*i/N
}
di = function(s,i,beta,gamma){
beta*s*i/N-gamma*i
}
sim <- function(beta,gamma, time, h){
s = i = c()
s[1] = N-1
i[1] = 1
for(t in 2:(time/h)){
s[t] <- s[t-1] + h * ds(s[t-1],i[t-1],beta,gamma)
i[t] <- i[t-1] + h * di(s[t-1],i[t-1],beta,gamma)
}
return(i)
}
nobs = 70;nsims=20
N=1e6
x = 1:nobs
simulation<- function(beta,gamma,x){
out = ode(c(N-10,10), x, sir, list(beta=beta,gamma=gamma, method="ode45"))[,3]
(out)
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
sim_test=array(c(runif(1,.5,1),runif(1,0,.5)))
ytest=log((simulation(sim_test[1],sim_test[2],x))+1)
ytest=ytest-mean(cbind(ysims,ytest))
oldmean = rowMeans(ysims)
ysims=ysims-mean(ysims)
matplot((ysims),type="l")
points(ytest,pch=8)
model_data = list('T'=nrow(ysims),num_series=ncol(ysims),
y=ysims,p=2,
theta=matrix(sim_pars,ncol=2),num_pred=nrow(matrix(sim_test,nrow=1)),
theta_pred=matrix(sim_test,nrow=1),lags=1,inits=as.array(ytest[1]))
file <- file.path("dlm_emulator_kalman.stan")
model <- cmdstan_model(file)
mcmc <- model$sample(data = model_data,
max_treedepth = 10,adapt_delta = .8,
chains = 2,
iter_warmup = 250,
iter_sampling =250,
refresh = 2, parallel_chains = getOption("mc.cores", 4))
stanfit <- rstan::read_stan_csv(mcmc$output_files())
#launch_shinystan(stanfit)
#summary(stanfit,pars=c("alp","alp1","alp2","beta","tau","sig","calibrate"))$summary
#summary(stanfit)
# sort(summary(stanfit,pars=c("gamma_z"))$summary[,1],decreasing = T)
# a=summary(stanfit,pars=c("C"))$summary
# b=matrix(a[,1],nrow=ncol(ysims),ncol=ncol(ysims))
# traceplot(stanfit,pars=c("sigma","lambda","rho"))
ypred = mcmc$draws("ypred")
yz1=yz2=yz3=yz3=yz4=yz5=yz6=yz7=yz8=yz9=ypredmean=u=l=out= c()
for(i in 1:(nobs)){
ypredmean[i] = median((c(ypred[,,i])))
l[i] = quantile(c(ypred[,,i]),0.025)
u[i] = quantile(c(ypred[,,i]),0.975)
}
plot(exp(ytest),ylim=c(min(exp(ytest),exp(ypredmean),exp(l)),max(exp(ytest),exp(ypredmean),exp(u))),col="blue",pch=19)
points(exp(ypredmean),col="red",lwd=3)
lines(exp(u),col="black",lwd=3,lty=3)
lines(exp(l),col="black",lwd=3,lty=3)
library(lhs)
library(geostats)
library(deSolve)
library(cmdstanr)
library(rstan)
library(truncnorm)
library(shinystan)
sir <- function(t, y, params) {
with(as.list(c(params, y)), {
S = y[1]
I = y[2]
dS = -beta*S*I/N
dI = beta*S*I/N-gamma*I
list(c(dS,dI))
})
}
ds = function(s,i,beta,gamma){
-beta*s*i/N
}
di = function(s,i,beta,gamma){
beta*s*i/N-gamma*i
}
sim <- function(beta,gamma, time, h){
s = i = c()
s[1] = N-1
i[1] = 1
for(t in 2:(time/h)){
s[t] <- s[t-1] + h * ds(s[t-1],i[t-1],beta,gamma)
i[t] <- i[t-1] + h * di(s[t-1],i[t-1],beta,gamma)
}
return(i)
}
nobs = 100;nsims=20
N=1e6
x = 1:nobs
simulation<- function(beta,gamma,x){
out = ode(c(N-10,10), x, sir, list(beta=beta,gamma=gamma, method="ode45"))[,3]
(out)
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
sim_test=array(c(runif(1,.5,1),runif(1,0,.5)))
ytest=log((simulation(sim_test[1],sim_test[2],x))+1)
ytest=ytest-mean(cbind(ysims,ytest))
oldmean = rowMeans(ysims)
ysims=ysims-mean(ysims)
matplot((ysims),type="l")
points(ytest,pch=8)
model_data = list('T'=nrow(ysims),num_series=ncol(ysims),
y=ysims,p=2,
theta=matrix(sim_pars,ncol=2),num_pred=nrow(matrix(sim_test,nrow=1)),
theta_pred=matrix(sim_test,nrow=1),lags=1,inits=as.array(ytest[1]))
file <- file.path("dlm_emulator_kalman.stan")
model <- cmdstan_model(file)
mcmc <- model$sample(data = model_data,
max_treedepth = 10,adapt_delta = .8,
chains = 2,
iter_warmup = 250,
iter_sampling =250,
refresh = 2, parallel_chains = getOption("mc.cores", 4))
stanfit <- rstan::read_stan_csv(mcmc$output_files())
#launch_shinystan(stanfit)
#summary(stanfit,pars=c("alp","alp1","alp2","beta","tau","sig","calibrate"))$summary
#summary(stanfit)
# sort(summary(stanfit,pars=c("gamma_z"))$summary[,1],decreasing = T)
# a=summary(stanfit,pars=c("C"))$summary
# b=matrix(a[,1],nrow=ncol(ysims),ncol=ncol(ysims))
# traceplot(stanfit,pars=c("sigma","lambda","rho"))
ypred = mcmc$draws("ypred")
yz1=yz2=yz3=yz3=yz4=yz5=yz6=yz7=yz8=yz9=ypredmean=u=l=out= c()
for(i in 1:(nobs)){
ypredmean[i] = median((c(ypred[,,i])))
l[i] = quantile(c(ypred[,,i]),0.025)
u[i] = quantile(c(ypred[,,i]),0.975)
}
plot(exp(ytest),ylim=c(min(exp(ytest),exp(ypredmean),exp(l)),max(exp(ytest),exp(ypredmean),exp(u))),col="blue",pch=19)
points(exp(ypredmean),col="red",lwd=3)
lines(exp(u),col="black",lwd=3,lty=3)
lines(exp(l),col="black",lwd=3,lty=3)
simulation2<- function(beta,gamma,x){
for(i in 1:100){
10*beta+sin(gamma*i)
}
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation2(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
sim_test=array(c(runif(1,.5,1),runif(1,0,.5)))
ytest=log((simulation(sim_test[1],sim_test[2],x))+1)
ytest=ytest-mean(cbind(ysims,ytest))
oldmean = rowMeans(ysims)
ysims=ysims-mean(ysims)
matplot((ysims),type="l")
points(ytest,pch=8)
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation2(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
matplot(ysims,type="l")
ysims
temp
simulation2<- function(beta,gamma,x){
for(i in 1:100){
10*beta+sin(gamma*i)
}
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation2(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
matplot(ysims,type="l")
sim_test=array(c(runif(1,.5,1),runif(1,0,.5)))
ytest=log((simulation(sim_test[1],sim_test[2],x))+1)
temp
simulation2(beta,gamma,x)
simulation2<- function(beta,gamma,x){
out=c()
for(i in 1:100){
out[i] = 10*beta+sin(gamma*i)
}
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation2(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
matplot(ysims,type="l")
temp
simulation2(beta,gamma,x)
simulation2<- function(beta,gamma,x){
out=c()
for(i in 1:100){
out[i] = 10*beta+sin(gamma*i)
}
return(out)
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation2(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
matplot(ysims,type="l")
simulation2<- function(beta,gamma,x){
out=c()
for(i in 1:100){
out[i] = 10+sin(gamma*i)/beta
}
return(out)
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation2(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
matplot(ysims,type="l")
simulation2<- function(beta,gamma,x){
out=c()
for(i in 1:100){
out[i] = 10+sin(gamma*i)*beta
}
return(out)
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation2(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
matplot(ysims,type="l")
simulation2<- function(beta,gamma,x){
out=c()
for(i in 1:100){
out[i] = 10+sin(gamma*i/100)*beta
}
return(out)
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation2(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
matplot(ysims,type="l")
simulation2<- function(beta,gamma,x){
out=c()
for(i in 1:100){
out[i] = 10+sin(gamma*i/10)*beta
}
return(out)
}
A <- maximinLHS(nsims, 2)
B <- matrix(nrow = nrow(A), ncol = ncol(A))
B[,1] <- qunif(A[,1], .5, 1)
B[,2] <- qunif(A[,2], 0, .5)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation2(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
matplot(ysims,type="l")
sim_test=array(c(runif(1,.5,1),runif(1,0,.5)))
ytest=log((simulation(sim_test[1],sim_test[2],x))+1)
ytest=ytest-mean(cbind(ysims,ytest))
oldmean = rowMeans(ysims)
ysims=ysims-mean(ysims)
matplot((ysims),type="l")
points(ytest,pch=8)
#B[,1] = B[,1]*B[,2]
ysims=sim_pars=c()
for(i in 1:(nrow(B))){
beta = B[i,1]
gamma = B[i,2]
temp = simulation2(beta,gamma,x)
ysims=cbind(ysims,temp)
sim_pars=rbind(sim_pars,c(beta,gamma))
}
ysims=matrix(log(ysims+1),nrow =nobs, ncol = nsims)
matplot(ysims,type="l")
sim_test=array(c(runif(1,.5,1),runif(1,0,.5)))
ytest=log((simulation2(sim_test[1],sim_test[2],x))+1)
ytest=ytest-mean(cbind(ysims,ytest))
oldmean = rowMeans(ysims)
ysims=ysims-mean(ysims)
matplot((ysims),type="l")
points(ytest,pch=8)
model_data = list('T'=nrow(ysims),num_series=ncol(ysims),
y=ysims,p=2,
theta=matrix(sim_pars,ncol=2),num_pred=nrow(matrix(sim_test,nrow=1)),
theta_pred=matrix(sim_test,nrow=1),lags=1,inits=as.array(ytest[1]))
file <- file.path("dlm_emulator_kalman.stan")
model <- cmdstan_model(file)
model_data = list('T'=nrow(ysims),num_series=ncol(ysims),
y=ysims,p=2,
theta=matrix(sim_pars,ncol=2),num_pred=nrow(matrix(sim_test,nrow=1)),
theta_pred=matrix(sim_test,nrow=1),lags=1,inits=as.array(ytest[1]))
file <- file.path("dlm_emulator_kalman.stan")
model <- cmdstan_model(file)
mcmc <- model$sample(data = model_data,
max_treedepth = 10,adapt_delta = .8,
chains = 2,
iter_warmup = 250,
iter_sampling =250,
refresh = 2, parallel_chains = getOption("mc.cores", 4))
file <- file.path("dlm_emulator_kalman.stan")
model <- cmdstan_model(file)
rebuild_cmdstan()
